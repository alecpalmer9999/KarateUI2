(()=>{"use strict";var e;!function(e){e[e.Deny=0]="Deny",e[e.Accept=1]="Accept",e[e.Neutral=2]="Neutral"}(e||(e={}));const t=(t,n)=>{for(let o=0;o<t.length;o++){const s=t[o].getFilterResult(n);if(s==e.Deny)return!1;if(s==e.Accept)return!0}return!0};var n;!function(e){e[e.Silly=0]="Silly",e[e.Verbose=1]="Verbose",e[e.Debug=2]="Debug",e[e.Info=3]="Info",e[e.Warn=4]="Warn",e[e.Error=5]="Error"}(n||(n={}));const o="Communication",s=[],i=[],r=new class{constructor(e,t){this.appenders=e,this.logFilters=t,this.logsPerLevel=100,this.allLogs={},this.sendTimeByMessage={};for(const e in n){const t=Number(n[e]);this.allLogs[t]=[]}}getHistory(e){return this.allLogs[e]}log(e,n,o,s){const i={level:e,message:n,subject:s,data:o,time:Date.now()};t(this.logFilters,i)&&(this.addToLogHistory(i),this.appenders.map((e=>{try{e.log(i)}catch(e){}})))}addToLogHistory(e){for(const t in n){const o=Number(n[t]);if(o<=e.level){const t=this.allLogs[o];for(t.push(e);t.length>this.logsPerLevel;)t.splice(0,1)}}}silly(e,t,o){this.log(n.Silly,e,t,o)}verbose(e,t,o){this.log(n.Verbose,e,t,o)}trace(e,t,o){this.log(n.Verbose,e,t,o)}debug(e,t,o){this.log(n.Debug,e,t,o)}info(e,t,o){this.log(n.Info,e,t,o)}warn(e,t,o){this.log(n.Warn,e,t,o)}error(e,t,o){this.log(n.Error,e,t,o)}daily(e,t,n,o,s){this.limited(e,t,n,864e5,o,s)}limited(e,t,n,o,s,i){const r=Date.now(),a=this.sendTimeByMessage[n];void 0!==a&&r-a<o?this.log(t,n,s,i):(this.sendTimeByMessage[n]=r,this.log(e,n,s,i))}}(i,s),a="consoleLog",c="logToEventCollector",l={};l[a]=n.Verbose,l[c]=n.Verbose,l.getLibItems=n.Verbose,l.forward=n.Verbose,l.response=n.Verbose;class u{constructor(e=!1){this.ignoreUnhandledMessages=e,this.events={}}handleMessage(e,t,s){var i;const a=null!==(i=l[e.action])&&void 0!==i?i:n.Debug;if(r.log(a,`MessageRouter - handleMessage (${e.action})`,e,o),!e.action)return r.debug(`message ${e} has no action, ignoring.`),!1;const c=this.events[e.action],u=this.checkCanHandle(e,c);return u.canHandle?(c.handle(e,s).then((n=>{r.log(a,`MessageRouter - done handling (${e.action})`,n,o),t&&t({success:!0,result:n})})).catch((e=>{t&&t({success:!1,error:e})})),!0):(!this.ignoreUnhandledMessages&&t&&t({success:!1,error:u.reason}),!1)}addMessageHandler(e){if(this.events[e.action])throw`action ${e.action} was already registered`;this.events[e.action]=e}getMessageHandler(e){return this.events[e]}removeMessageHandler(e){delete this.events[e]}checkCanHandle(e,t){return t?this.isOriginBlockedForHandler(e,t)?(r.debug(`blocked message ${e.action} from ${e.originPart} due to blocked origin`),{canHandle:!1,reason:"origin not allowed"}):this.isOriginAllowedForHandler(e,t)?{canHandle:!0}:(r.debug(`blocked message ${e.action} from ${e.originPart} due to not allowed origin`),{canHandle:!1,reason:"origin not allowed"}):(r.debug(`message ${e.action} from ${e.originPart} has no handler`),{canHandle:!1,reason:"unknown action: "+e.action})}isOriginBlockedForHandler(e,t){return!(!t.blockedOrigins||!t.blockedOrigins.length)&&!(void 0!==e.originPart&&!t.blockedOrigins.includes(e.originPart))}isOriginAllowedForHandler(e,t){return!t.allowedOrigins||!t.allowedOrigins.length||!(void 0===e.originPart||!t.allowedOrigins.includes(e.originPart))}}const d=(e,t)=>{if(t instanceof Error)try{const e={};return Object.getOwnPropertyNames(t).forEach((n=>{e[n]=t[n]})),e}catch(e){}return t};var h;!function(e){e[e.Background=1]="Background",e[e.ActiveTabTopContent=2]="ActiveTabTopContent",e[e.ActiveTabTopPage=3]="ActiveTabTopPage",e[e.AllContents=4]="AllContents",e[e.AllPages=5]="AllPages",e[e.OwnerContent=6]="OwnerContent",e[e.OwnedPage=7]="OwnedPage",e[e.OptionsPage=8]="OptionsPage",e[e.ActionPage=9]="ActionPage",e[e.SiblingContent=10]="SiblingContent",e[e.SiblingMediator=11]="SiblingMediator",e[e.Offscreen=12]="Offscreen"}(h||(h={}));const g=e=>new Promise((t=>{setTimeout((()=>t()),e)})),f=(e,t)=>new Promise(((n,o)=>{let s=!1,i=!1;e.then((e=>{s||(i=!0,n(e))})).catch((e=>{s||o(e)})),g(t).then((()=>{i||(s=!0,o("timeout"))}))}));class v{constructor(e){this.name=e}set(e){this.data=e}get(){if(void 0===this.data)throw`'${this.name} - data was not yet set`;return this.data}}const m=new v("sendMessageProvider"),w=(e,t)=>{return n=void 0,o=void 0,i=function*(){return m.get()(t,e)},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{c(i.next(e))}catch(e){t(e)}}function a(e){try{c(i.throw(e))}catch(e){t(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,a)}c((i=i.apply(n,o||[])).next())}));var n,o,s,i};var p=function(e,t,n,o){return new(n||(n=Promise))((function(s,i){function r(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};class y{constructor(e,t,n){var o,s,i;this.action=e,this.target=t,this.needsResponse=null===(o=null==n?void 0:n.needsResponse)||void 0===o||o,this.timeout=null!==(s=null==n?void 0:n.timeout)&&void 0!==s?s:3e3,this.autoRetry=null===(i=null==n?void 0:n.autoRetry)||void 0===i||i}createMessage(e){return{action:this.action,needsResponse:this.needsResponse,data:e}}send(e){var t;return p(this,void 0,void 0,(function*(){const s=null!==(t=l[this.action])&&void 0!==t?t:n.Debug;r.trace(`messageSender send was called for action ${this.action}`,e,o);const i=this.createMessage(e);r.log(s,`messageSender - sending message (${this.action})`,i,o);let a=0;for(;;)try{const e=w(i,this.target),t=yield f(e,this.timeout);return r.log(s,`messageSender - got result for message (${i.action})`,t,o),t}catch(e){if(!this.autoRetry){if(this.needsResponse)throw e;return}if(a++,a>5)throw r.debug(`messageSender failed for message (${i.action}), max retries reached.`,e,o),e;yield g(500),r.trace(`messageSender failed for message (${i.action}), retrying`,e,o)}throw"timeout"}))}}class b extends y{constructor(e,t,n){super(e,t,n)}send(e){const t=Object.create(null,{send:{get:()=>super.send}});return p(this,void 0,void 0,(function*(){return t.send.call(this,e)}))}}const x=new b(c,h.Background,{needsResponse:!1}),P=e=>{return t=void 0,n=void 0,s=function*(){if(e.data)try{e.data=(e=>{if(void 0===e)return e;const t=JSON.stringify(e,d);return JSON.parse(t)})(e.data)}catch(e){}x.send(e)},new((o=void 0)||(o=Promise))((function(e,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o((function(e){e(n)}))).then(r,a)}c((s=s.apply(t,n||[])).next())}));var t,n,o,s},L=new y("getLoggerConfiguration",h.Background),M=()=>L.send();class O{constructor(e){this.subjectsToDeny=e}getFilterResult(t){return t.subject&&this.subjectsToDeny.indexOf(t.subject)>-1?e.Deny:e.Neutral}}const I=new v("currentExtensionPartProvider");class T{getFilterResult(t){return e.Deny}}class C{constructor(e){this.minLogLevel=e}getFilterResult(t){return t.level<this.minLogLevel?e.Deny:e.Neutral}}class R extends C{constructor(e){super(e),this.minLogLevel=e}getFilterResult(t){return"undefined"==typeof window||window==(null===window||void 0===window?void 0:window.top)?e.Neutral:super.getFilterResult(t)}}const H=["Content","Page","ContentMediator"],k=e=>{const t=[];e.enabled||t.push(new T);const n=I.get();return H.includes(n)&&t.push(new R(e.minIframeLogLevel)),t.push(new C(e.minTopLogLevel)),t};new b(a,h.ActiveTabTopContent,{autoRetry:!1,needsResponse:!1});const $=new v("logToConsoleProvider");var E=function(e,t,n,o){return new(n||(n=Promise))((function(s,i){function r(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};const F=(...e)=>E(void 0,void 0,void 0,(function*(){console.log(...e)}));class A{constructor(e,t){this.logFilters=e,this.rateLimitEnforcer=t,this.didNotifyRateExceed=!1}handleRateLimitBlock(e){var t;if(this.didNotifyRateExceed)return;this.didNotifyRateExceed=!0;const o=((e,t)=>({level:n.Warn,message:"Rate limit blocked",time:e.time,data:{blockedLogMessage:e,rateLimit:t}}))(e,null===(t=this.rateLimitEnforcer)||void 0===t?void 0:t.rateLimit);this.logImpl(o)}log(e){t(this.logFilters,e)&&(!this.rateLimitEnforcer||this.rateLimitEnforcer.isAllowed()?this.logImpl(e):this.handleRateLimitBlock(e))}}class D extends A{constructor(){super(...arguments),this.currentLogs=[]}logImpl(e){return t=this,o=void 0,i=function*(){const t=e.subject?e.subject+" - ":"",o=`[${n[e.level]}]`;if(!this.currentLogs.includes(e.message)){this.currentLogs.push(e.message);try{const n=I.get();yield((...e)=>E(void 0,void 0,void 0,(function*(){const t=$.get();t&&(yield t(...e))})))(`${new Date(e.time).toISOString()} [${n}] - ${o} ${t}${e.message}`,e.data)}catch(e){}const n=this.currentLogs.indexOf(e.message);this.currentLogs.splice(n,1)}},new((s=void 0)||(s=Promise))((function(e,n){function r(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,a)}c((i=i.apply(t,o||[])).next())}));var t,o,s,i}}const N=new v("logToEventCollectorProvider");class S extends A{logImpl(e){return t=this,n=void 0,s=function*(){const t=e;t.extensionPart=I.get();const n=N.get();n&&n(t)},new((o=void 0)||(o=Promise))((function(e,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o((function(e){e(n)}))).then(r,a)}c((s=s.apply(t,n||[])).next())}));var t,n,o,s}}const B=new v("currentLoggerConfigProvider");class j{constructor(e){this.rateLimit=e,this.timesHistory=[]}addToHistory(e){for(this.timesHistory.push(e);this.timesHistory.length>this.rateLimit.maxTimesInInterval;)this.timesHistory.splice(0,1)}isAllowed(){const e=Date.now(),t=((e,t,n,o,s)=>e>=o&&void 0!==t&&n-t<s)(this.timesHistory.length,this.timesHistory[0],e,this.rateLimit.maxTimesInInterval,this.rateLimit.intervalInMs);return!t&&(this.addToHistory(e),!0)}}const V=e=>{if(e)return new j(e)},W=new v("currentMessageOriginProvider");let U;U="undefined"!=typeof chrome?chrome:browser;const J=U.runtime.sendMessage,_=(U.runtime.reload,U.runtime.onInstalled,(e,t)=>new Promise(((n,o)=>{const s=t;s.originPart=W.get(),e(s,(e=>{const t=U.runtime.lastError;t?o("Runtime last error: "+t.message):(null==e?void 0:e.success)?n(e.result):o(null==e?void 0:e.error)}))})));const q=(e,t)=>{return n=void 0,o=void 0,i=function*(){if(e===h.Background)return(e=>_(J,e))(t);throw"cannot send from offscreen to "+e},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{c(i.next(e))}catch(e){t(e)}}function a(e){try{c(i.throw(e))}catch(e){t(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,a)}c((i=i.apply(n,o||[])).next())}));var n,o,s,i};class z{constructor(e,t){this.registerToMessages=e,this.router=t}start(){this.registerToMessages(((e,t,n)=>this.handleNativeMessage(e,t,n)))}handleNativeMessage(e,t,n){r.trace("handleNativeMessage",e,o);const s=(e=>({tabId:e.tab?e.tab.id:void 0,tabUrl:e.tab?e.tab.url:void 0,frameId:e.frameId}))(t);return this.router.handleMessage(e,n,s)}}const G=e=>{U.runtime.onMessage.addListener(e)};class K{constructor(e,t,n){this.action=e,this.allowedOrigins=t,this.blockedOrigins=n}handle(e,t){return n=this,s=void 0,a=function*(){if(r.trace("messageHandler handle called",e,o),e.action!=this.action)throw"unsupported action: "+e.action+", expected: "+this.action;const n=e.data;return this.handleImpl(n,t)},new((i=void 0)||(i=Promise))((function(e,t){function o(e){try{c(a.next(e))}catch(e){t(e)}}function r(e){try{c(a.throw(e))}catch(e){t(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(o,r)}c((a=a.apply(n,s||[])).next())}));var n,s,i,a}}var Q=function(e,t,n,o){return new(n||(n=Promise))((function(s,i){function r(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};const X=new b("iframeMessage",h.Background,{needsResponse:!1}),Y=new class{constructor(e){this.win=e,this.currentOpenFrames={},this.onIframeMessageCallbacks=[],this.iframeRunningId=0}init(){this.win.addEventListener("message",(e=>{Object.keys(this.currentOpenFrames).forEach((t=>{this.currentOpenFrames[t].contentWindow==e.source&&this.raiseMessage(t,e.data)}))}))}raiseMessage(e,t){this.onIframeMessageCallbacks.forEach((n=>{try{n(e,t)}catch(e){}}))}onMessage(e){this.onIframeMessageCallbacks.push(e)}openIframe(e){return Q(this,void 0,void 0,(function*(){const t=`${Date.now()}_${this.iframeRunningId++}`,n=this.createIframe(e);return this.win.document.body.appendChild(n),this.currentOpenFrames[t]=n,t}))}closeIframe(e){return Q(this,void 0,void 0,(function*(){const t=this.currentOpenFrames[e];t&&(this.win.document.body.removeChild(t),delete this.currentOpenFrames[e])}))}createIframe(e){const t=this.win.document.createElement("iframe");return t.setAttribute("sandbox","allow-same-origin allow-scripts allow-popups allow-forms"),t.setAttribute("src",e),t.style.width="800px",t.style.height="500px",t.style.opacity="1",t.style.position="fixed",t}}(window);Y.init(),Y.onMessage(((e,t)=>{const n={iframeId:e,data:t};X.send(n)}));const Z=new class extends K{constructor(){super("addIframe")}handleImpl(e){return t=this,n=void 0,s=function*(){return Y.openIframe(e)},new((o=void 0)||(o=Promise))((function(e,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o((function(e){e(n)}))).then(r,a)}c((s=s.apply(t,n||[])).next())}));var t,n,o,s}};const ee=[Z,new class extends K{constructor(){super("closeIframe")}handleImpl(e){return t=this,n=void 0,s=function*(){return Y.closeIframe(e)},new((o=void 0)||(o=Promise))((function(e,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o((function(e){e(n)}))).then(r,a)}c((s=s.apply(t,n||[])).next())}));var t,n,o,s}}];var te,ne;ne=function*(){var e,t,n,r,a;yield(e={extensionPart:"Offscreen",fetchLogConfig:M,logToEventCollector:P,sendMessageFunction:q},t=void 0,n=void 0,r=void 0,a=function*(){var t;I.set(e.extensionPart),W.set(null!==(t=e.messageOrigin)&&void 0!==t?t:e.extensionPart),m.set(e.sendMessageFunction),(e=>{B.set(e);const t=k(e.console),n=V(e.console.rateLimit),r=new D(t,n),a=k(e.remote);a.push(new O([o]));const c=V(e.remote.rateLimit),l=[r,new S(a,c)];var u;u=[],s.length=0,u.map((e=>s.push(e))),(e=>{i.length=0,e.map((e=>i.push(e)))})(l)})(yield e.fetchLogConfig()),N.set(e.logToEventCollector),$.set(e.logToConsole||F)},new(r||(r=Promise))((function(e,o){function s(e){try{c(a.next(e))}catch(e){o(e)}}function i(e){try{c(a.throw(e))}catch(e){o(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(s,i)}c((a=a.apply(t,n||[])).next())})));const c=new u(!0);var l,d;new z(G,l=c).start(),d=l,ee.map((e=>{try{d.addMessageHandler(e)}catch(e){}}))},new((te=void 0)||(te=Promise))((function(e,t){function n(e){try{s(ne.next(e))}catch(e){t(e)}}function o(e){try{s(ne.throw(e))}catch(e){t(e)}}function s(t){var s;t.done?e(t.value):(s=t.value,s instanceof te?s:new te((function(e){e(s)}))).then(n,o)}s((ne=ne.apply(void 0,[])).next())}))})();